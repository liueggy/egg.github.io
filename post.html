<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>文章 · EGG</title>
        <meta
            name="description"
            content="阅读博客文章，正文来自 content/posts/{slug}.html，元信息来自 posts.json。"
        />
        <meta name="keywords" content="博客, 文章阅读, 极简, 毛玻璃, 黑白" />
        <meta name="author" content="EGG" />
        <link rel="canonical" href="https://egg.github.io/post.html" />
        <meta property="og:site_name" content="EGG" />
        <meta property="og:title" content="文章 · EGG" />
        <meta
            property="og:description"
            content="阅读博客文章，正文来自 content/posts/{slug}.html，元信息来自 posts.json。"
        />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://egg.github.io/post.html" />
        <meta name="twitter:card" content="summary" />
        <meta name="theme-color" content="#050505" />
        <link
            rel="icon"
            type="image/png"
            href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+Zf6kAAAAASUVORK5CYII="
        />
        <link
            rel="shortcut icon"
            href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+Zf6kAAAAASUVORK5CYII="
        />
        <link
            rel="apple-touch-icon"
            href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+Zf6kAAAAASUVORK5CYII="
        />
        <link rel="stylesheet" href="./assets/style.css" />
    </head>
    <body>
        <div class="background-blur"></div>
        <div class="page page-narrow">
            <header class="nav glass">
                <div class="logo">EGG</div>
                <nav class="nav-links">
                    <a href="./blog.html">博客</a>
                    <a href="./learning.html">学习记录</a>
                    <a href="./about.html">关于</a>
                </nav>
                <div class="pill">文章阅读</div>
            </header>

            <main>
                <section class="section glass">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">阅读</p>
                            <h1 id="post-title">加载中...</h1>
                            <p class="muted" id="post-meta"></p>
                            <div class="tags" id="post-tags"></div>
                        </div>
                        <a class="button ghost" href="./blog.html">返回列表</a>
                    </div>
                    <article id="post-body" class="article"></article>
                </section>
            </main>

            <footer class="footer">
                <p class="muted">
                    内容来自 content/posts/{slug}.html · 元信息来自 posts.json
                </p>
            </footer>
        </div>

        <script>
            function escapeHTML(str = "") {
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            }

            async function loadPost() {
                const params = new URLSearchParams(location.search);
                const slug = params.get("slug") || "hello-world";
                const safeSlug = slug.trim() || "hello-world";
                const target = `./content/posts/${safeSlug}.html`;

                const metaEl = document.getElementById("post-meta");
                const titleEl = document.getElementById("post-title");
                const bodyEl = document.getElementById("post-body");
                const tagsEl = document.getElementById("post-tags");
                const descMeta = document.querySelector(
                    'meta[name="description"]',
                );
                const ogTitleMeta = document.querySelector(
                    'meta[property="og:title"]',
                );
                const ogDescMeta = document.querySelector(
                    'meta[property="og:description"]',
                );

                titleEl.textContent = "加载中...";
                metaEl.textContent = "正在读取文章与元数据...";
                bodyEl.innerHTML = '<p class="muted">正文加载中...</p>';

                try {
                    const [metaRes, htmlRes] = await Promise.all([
                        fetch("./content/posts/posts.json?_" + Date.now()),
                        fetch(target + "?_" + Date.now()),
                    ]);

                    if (!htmlRes.ok) throw new Error("未找到对应文章内容文件");
                    const html = await htmlRes.text();

                    let meta = {};
                    if (metaRes.ok) {
                        const list = await metaRes.json();
                        meta = list.find((p) => p.slug === safeSlug) || {};
                    }

                    const displayTitle = meta.title || safeSlug;
                    const displayDate = meta.date || "时间未填";
                    const displayStatus = meta.status || "发布";
                    const displayDesc = meta.summary || meta.description || "";

                    titleEl.textContent = displayTitle;
                    document.title = `${displayTitle} · EGG`;
                    metaEl.textContent = `${displayDate} · ${displayStatus}`;
                    if (descMeta) {
                        descMeta.setAttribute(
                            "content",
                            displayDesc || `阅读 ${displayTitle}`,
                        );
                    }
                    if (ogTitleMeta) {
                        ogTitleMeta.setAttribute(
                            "content",
                            `${displayTitle} · EGG`,
                        );
                    }
                    if (ogDescMeta) {
                        ogDescMeta.setAttribute(
                            "content",
                            displayDesc || `阅读 ${displayTitle}`,
                        );
                    }
                    if (tagsEl) {
                        tagsEl.innerHTML = Array.isArray(meta.tags)
                            ? meta.tags
                                  .map(
                                      (t) =>
                                          `<span class="tag">${escapeHTML(
                                              t,
                                          )}</span>`,
                                  )
                                  .join("")
                            : "";
                    }
                    bodyEl.innerHTML = html;
                } catch (err) {
                    titleEl.textContent = "加载失败";
                    metaEl.textContent = err.message;
                    bodyEl.innerHTML =
                        '<p class="muted">检查文件路径或 slug 参数，或稍后再试。</p>';
                }
            }

            loadPost();
        </script>
    </body>
</html>
